-- SQL Database Changes for Murder Mystery Story Updates
-- This file contains queries to track story element changes and enhancements

-- Create table for story chapters if it doesn't exist
CREATE TABLE IF NOT EXISTS chapters (
    chapter_id INTEGER PRIMARY KEY,
    chapter_title VARCHAR(255) NOT NULL,
    chapter_number INTEGER NOT NULL,
    word_count INTEGER,
    last_modified TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'draft'
);

-- Create table for tracking story enhancements
CREATE TABLE IF NOT EXISTS story_enhancements (
    enhancement_id INTEGER PRIMARY KEY AUTOINCREMENT,
    chapter_id INTEGER,
    enhancement_type VARCHAR(100) NOT NULL,
    description TEXT,
    date_applied TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (chapter_id) REFERENCES chapters(chapter_id)
);

-- Create table for transit/travel details added to the story
CREATE TABLE IF NOT EXISTS transit_details (
    transit_id INTEGER PRIMARY KEY AUTOINCREMENT,
    chapter_id INTEGER,
    location_from VARCHAR(255),
    location_to VARCHAR(255),
    travel_time_minutes INTEGER,
    description TEXT,
    FOREIGN KEY (chapter_id) REFERENCES chapters(chapter_id)
);

-- Create table for atmospheric/small detail enhancements
CREATE TABLE IF NOT EXISTS atmospheric_details (
    detail_id INTEGER PRIMARY KEY AUTOINCREMENT,
    chapter_id INTEGER,
    detail_type VARCHAR(100),
    description TEXT,
    FOREIGN KEY (chapter_id) REFERENCES chapters(chapter_id)
);

-- Insert chapter records
INSERT INTO chapters (chapter_id, chapter_title, chapter_number, status) VALUES
(1, 'The Last Ashworth', 1, 'revised'),
(2, 'The Family Gathers', 2, 'revised'),
(3, 'Final Words', 3, 'revised'),
(4, 'Midnight Confessions', 4, 'revised'),
(5, 'Three Hands, One Death', 5, 'revised'),
(6, 'A Fatal Message', 6, 'revised'),
(7, 'Reckoning at the Boathouse', 7, 'revised'),
(8, 'Julian''s Confession', 8, 'revised'),
(9, 'Sarah''s Secrets', 9, 'revised'),
(10, 'Sparks and Tinder', 10, 'revised'),
(11, 'Standing Among Stones', 11, 'revised'),
(12, 'Web of Complicity', 12, 'revised'),
(13, 'Behind Locked Doors', 13, 'revised'),
(14, 'Shadows in the Windows', 14, 'revised'),
(15, 'A Fourth Hand Revealed', 15, 'revised'),
(16, 'Marcus Webb''s Legacy', 16, 'revised');

-- Insert enhancement records for transit details added
INSERT INTO story_enhancements (chapter_id, enhancement_type, description) VALUES
(1, 'transit_detail', 'Added 20-minute drive through empty streets with traffic light stops'),
(1, 'transit_detail', 'Added half-mile driveway approach to estate with gate check'),
(2, 'transit_detail', 'Added corridor navigation to conservatory location'),
(3, 'transit_detail', 'Added 55-minute drive time from Sterling office with construction delay'),
(3, 'transit_detail', 'Added maze navigation through butler pantry to kitchen'),
(4, 'transit_detail', 'Added evening commute drive back to apartment'),
(4, 'transit_detail', 'Added 11:15 PM departure time for chapel drive'),
(5, 'transit_detail', 'Added 40-minute drive with wrong turn and fender-bender detour'),
(5, 'transit_detail', 'Added gate check with Officer Chen'),
(6, 'transit_detail', 'Added Seattle to Minneapolis connection flight timeline'),
(6, 'transit_detail', 'Added 15-minute hospital drive with parking challenges'),
(7, 'transit_detail', 'Added 20-minute drive to marina via back roads'),
(7, 'transit_detail', 'Added 50-yard dock walk to boathouse'),
(9, 'transit_detail', 'Added 20-minute drive through increasingly shabby neighborhoods'),
(9, 'transit_detail', 'Added 8:47 PM arrival time check'),
(10, 'transit_detail', 'Added basement corridor navigation to holding cells'),
(10, 'transit_detail', 'Added 30-minute transport drive to station'),
(11, 'transit_detail', 'Added 15-minute scenic route past old mill'),
(12, 'transit_detail', 'Added detour through warehouse district due to construction'),
(13, 'transit_detail', 'Added 7:30 AM departure with gas stop on Pine Street'),
(14, 'transit_detail', 'Added 20-minute drive with counter-surveillance route'),
(15, 'transit_detail', 'Added 15-minute route through professional quarter'),
(16, 'transit_detail', 'Added 40-minute drive with two wrong turns, 6:23 AM timestamp');

-- Insert atmospheric detail enhancements
INSERT INTO atmospheric_details (chapter_id, detail_type, description) VALUES
(1, 'sensory', 'Added refrigerator hum and passing car headlights'),
(1, 'sensory', 'Added engine ticking after parking'),
(1, 'time', 'Added grandfather clock ticking in crime scene'),
(1, 'visual', 'Added crime scene photographer flash'),
(2, 'object', 'Added crystal tumbler detail for Victor'),
(2, 'time', 'Added dinner duration details (four-course meal)'),
(2, 'behavior', 'Added cigarette lighting as coping mechanism'),
(3, 'object', 'Added wine stain and saltshaker details'),
(3, 'navigation', 'Added directions to chapel on note'),
(4, 'behavior', 'Added minute of listening to cooling metal before exit'),
(4, 'position', 'Added tactical positioning in pew with wall behind'),
(5, 'object', 'Added coroner van parked detail'),
(6, 'environment', 'Added engine idling for warmth in cruiser'),
(8, 'object', 'Added yellow evidence markers on Persian rug'),
(8, 'time', 'Added grandfather clock showing 5:47 AM'),
(11, 'nature', 'Added crow calling and flying off'),
(12, 'object', 'Added railway clock backstory'),
(12, 'visual', 'Added patrol officers through window'),
(13, 'behavior', 'Added oil painting study during wait'),
(14, 'visual', 'Added passing car headlights on curtains'),
(16, 'time', 'Added 6:23 AM timestamp'),
(16, 'sound', 'Added footstep counting and stair groaning');

-- Update chapter modification timestamps
UPDATE chapters SET last_modified = CURRENT_TIMESTAMP WHERE chapter_id BETWEEN 1 AND 16;

-- Create index for faster queries on enhancement types
CREATE INDEX IF NOT EXISTS idx_enhancement_type ON story_enhancements(enhancement_type);
CREATE INDEX IF NOT EXISTS idx_detail_type ON atmospheric_details(detail_type);

-- Summary query to view all enhancements by chapter
-- SELECT c.chapter_number, c.chapter_title,
--        COUNT(DISTINCT se.enhancement_id) as transit_enhancements,
--        COUNT(DISTINCT ad.detail_id) as atmospheric_enhancements
-- FROM chapters c
-- LEFT JOIN story_enhancements se ON c.chapter_id = se.chapter_id
-- LEFT JOIN atmospheric_details ad ON c.chapter_id = ad.chapter_id
-- GROUP BY c.chapter_id
-- ORDER BY c.chapter_number;
